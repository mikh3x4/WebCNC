<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
    <link rel="stylesheet" href="grid.css">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Web Pen Plotter</title>
    <!-- <link rel="stylesheet" href="pyscript/pyscript.css" /> -->
    <script defer src="pyscript/pyscript.js"></script>
    <script defer src="serial_sender.js"></script>

</head>

<body>
        <!-- packages = ["vpype==1.13.0", "vpype-gcode", "vpype-dxf", "vpype-vectrace", "vpype-occult==0.3.0", "opencv-python", "matplotlib", "scikit-image"] -->
    <py-config>
        packages = ["vpype==1.13.0", "vpype-gcode", "vpype-dxf", "vpype-vectrace", "vpype-occult==0.3.0"]
        [splashscreen]
            enabled = false
    </py-config>
    <!-- <py-script src="hatched.py"> </py-script> -->
    <py-script src="penslicer.py"> </py-script>

<div class="container">
  <div class="Send-Command" style="display: flex; align-items: center;">

    <input type="text" id="lineToSend" style="flex: 1; ">
    <button onclick="sendSerialLine()" style="width: 50px; ">Send</button>
  </div>
  <div class="Blank"></div>
  <div class="Gcode-History">



    <div class="Banner"> 
    <h1>
      Serial Console
    </h1>
    </div>

    <div id="serialResults"></div>

  </div>
  <div class="Slicing-Area">
    <div class="Banner2">
      <h1>
      Gcode Preview
      </h1>
    </div>

    <div id="output-image" style="overflow:scroll;"> </div>
  </div>
  <div class="Slicing-commands">
    <h1>
      Gcode Generation
    </h1>
    <input type="file" id="file-upload" accept=".svg,.dxf,.png,.gcode" /><br>

    <button id="process-button" py-click="loop.create_task(wrap(process_file()))">Process File</button><br>
    <button id="download-gcode-button" py-click="downloadFile()">Download Gcode</button><br>

    Width: <input type="text" id="width_box" value="11cm"><br>
    Height: <input type="text" id="height_box" value="7cm"><br>

    <button id="slice-config">Advanced Config</button>
  </div>
  <div class="Command-Buttons">

      <h1>
      Plotter Control
      </h1>

<br>
<button onclick="connectSerial()">Connect</button><br>

<button onclick="sendData('M17')">Motor On</button>
<button onclick="sendData('M18')">Motors Off</button><br>

<button onclick="sendData('G21G91Y-5F1000')">Move Y-</button>
<button onclick="sendData('G21G91Y5F1000')">Move Y+</button><br>
<button onclick="sendData('G21G91X-5F1000')">Move X-</button>
<button onclick="sendData('G21G91X5F1000')">Move X+</button><br>
<button onclick="sendData(document.querySelector('#pen-up-command').value)">Pen Up</button>
<button onclick="sendData(document.querySelector('#pen-down-command').value)">Pen Down</button><br>
<button onclick="estop_var = true;sendData('!');">ESTOP</button>
<button onclick="estop_var = false;sendData('~');">Resume</button><br>

<button onclick="rungcode('gcode')">Run Gcode</button>
<button onclick="rungcode('gcode_bbox')>Run Outline</button><br>

<button onclick="serialResultsDiv.innerHTML = '';">Clear</button>
<label for="echoOn">
    <input type="checkbox" id="echoOn" onclick="localStorage.echoOn = this.checked;" checked>echo
</label>

  </div>
</div>

    <py-repl id="my-repl" auto-generate="true"> </py-repl>

<dialog>
  <button autofocus style="float:right;">Close</button> <br>

  <label for="story">Vpype gcode config</label> <br>

<textarea id="vpype-gcode-settings" name="vpype-gcode-settings" rows="20" cols="100">
  placeholder
</textarea>

  <div>Vpype pipeline options</div>
  <input type="text" id="vpype-pipline-config" style="width:100%;" value="placeholder">

  <div>Pen Up command</div>
  <input type="text" id="pen-up-command" value="placeholder">
  <br>

  <div>Pen Down command</div>
  <input type="text" id="pen-down-command" value="placeholder">
  <br>

  <button id="restore-settings">Restore</button>
  <button id="save-settings">Save</button>
</dialog>

<script>
  const dialog = document.querySelector("dialog");
  const showButton = document.querySelector("#slice-config");
  const closeButton = document.querySelector("dialog button");

  //qs = document.querySelector
  load_advanced_settings = () => {
    if(localStorage.getItem('save-settings') == null){
      console.log("no settings found")
      document.querySelector("#vpype-pipline-config").value="linemerge --tolerance 0.1mm linesort scaleto {width} {height} layout tight gwrite --profile my_own_plotter output.gcode"
      document.querySelector("#pen-up-command").value="M10 P0 S30"
      document.querySelector("#pen-down-command").value="M10 P0 S100"

      document.querySelector("#vpype-gcode-settings").value=`[gwrite.my_own_plotter]
unit = "mm"
document_start = "G90;\\nG10 P0 L20 X0 Y0 Z0;\\n"
layer_start = ""
line_start = ""
segment_first = """G0 X{x:.4f} Y{y:.4f};\\nM10 P0 S100;\\n"""
segment = """G01 X{x:.4f} Y{y:.4f} F1000\\n"""
line_end = """M10 P0 S30;\\n"""
document_end = "M10 P0 S30;\\nG0 X0 Y0"
invert_y = true
`

    }else{
      document.querySelector("#vpype-pipline-config").value=localStorage.getItem('vpype-pipline-config')
      document.querySelector("#pen-up-command").value=localStorage.getItem('pen-up-command')
      document.querySelector("#pen-down-command").value=localStorage.getItem('pen-down-command')
      document.querySelector("#vpype-gcode-settings").value=localStorage.getItem('vpype-gcode-settings')

    }
  }

  load_advanced_settings();

  document.querySelector("dialog #save-settings").addEventListener("click", () => {
    localStorage.setItem('save-settings', 1 );
    localStorage.setItem('vpype-pipline-config', document.querySelector("#vpype-pipline-config").value );
    localStorage.setItem('pen-up-command', document.querySelector("#pen-up-command").value );
    localStorage.setItem('pen-down-command', document.querySelector("#pen-down-command").value );
    localStorage.setItem('vpype-gcode-settings', document.querySelector("#vpype-gcode-settings").value );
    alert("settings saved")
  });

  document.querySelector("dialog #restore-settings").addEventListener("click", () => {
    if (confirm("Are you sure you want to restore settings?")) {
      localStorage.removeItem('save-settings');
      load_advanced_settings();
    }
  });

  showButton.addEventListener("click", () => {
    dialog.showModal();
  });

  closeButton.addEventListener("click", () => {
    dialog.close();
  });

</script>

</body>

</html>
