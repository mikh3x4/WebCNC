<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Some plotting</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>

<body>
    <div id="matplotlib-lineplot"></div>
    <input type="file" id="file-upload" accept=".svg,.dxf,.png" />

    <button id="process-button" py-click="loop.create_task(process_file())">Process File</button>

    <div id="output-image"></div>
    <div id="output"></div>

<!-- vpype-dxf==0.2.0 -->
<!-- vpype-gcode==0.13.0 -->
<!-- vpype-occult==0.4.0 -->
<!-- vpype-vectrace==0.1.2 -->
    <py-config>
        packages = ["vpype==1.13.0", "vpype-gcode"]
        [splashscreen]
            enabled = false
    </py-config>

    <py-script output="matplotlib-lineplot">

config='''
[gwrite.my_own_plotter]
unit = "mm"
document_start = "G90;\\nG10 P0 L20 X0 Y0 Z0;\\n"
layer_start = ""
line_start = ""
# segment_first = """G0 X{x:.4f} Y{y:.4f};
# M10 P0 S100;\\nG04 P500;\\n"""
segment_first = """G0 X{x:.4f} Y{y:.4f};
M10 P0 S100;\\n"""
segment = """G01 X{x:.4f} Y{y:.4f} F1000\\n"""
# line_end = """M10 P0 S30;\\nG04 P500;\\n"""
line_end = """M10 P0 S30;\\n"""
document_end = "M10 P0 S30\\nG0 X0 Y0"
invert_y = true
'''

with open("config.toml", "w") as f:
    f.write(config)

import asyncio
loop = asyncio.get_event_loop()

import time
text = None

from pyscript import when

import js
def handler(loop, context):
    js.console.error(context.message)
    raise(context.exception)
loop.set_exception_handler(handler)


#@when('click', '#process-button')
async def process_file():
    global text
    file_input = Element("file-upload")
    uploaded_file = file_input.element.files.item(0)
    if uploaded_file is None:
        return

    display("hi", target="output")
    file_name = uploaded_file.name
    text = await uploaded_file.text()

    #text = loop.run_until_complete(uploaded_file.text())
    print("stating")

    print(text)
    display("helllo", target="output")

#from js import document
#from pyodide import create_proxy
#click_proxy = create_proxy(process_file)
#e = document.getElementById("process-button")
#e.addEventListener("click", click_proxy)

    </py-script>

    <py-repl id="my-repl" auto-generate="true"> </py-repl>

</body>

</html>
