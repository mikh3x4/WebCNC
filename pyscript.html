<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Some plotting</title>
    <link rel="stylesheet" href="https://pyscript.net/latest/pyscript.css" />
    <script defer src="https://pyscript.net/latest/pyscript.js"></script>
</head>

<body>
    <div id="matplotlib-lineplot"></div>
    <input type="file" id="file-upload" accept=".svg,.dxf,.png" />

    <button id="process-button" py-click="loop.create_task(process_file())">Process File</button>

    <div id="output-image"></div>
    <div id="output"></div>

<!-- vpype-dxf==0.2.0 -->
<!-- vpype-gcode==0.13.0 -->
<!-- vpype-occult==0.4.0 -->
<!-- vpype-vectrace==0.1.2 -->
    <py-config>
        packages = ["vpype==1.13.0", "vpype-gcode", "vpype-dxf", "vpype-vectrace"]
        [splashscreen]
            enabled = false
    </py-config>

    <py-script output="matplotlib-lineplot">

config='''
[gwrite.my_own_plotter]
unit = "mm"
document_start = "G90;\\nG10 P0 L20 X0 Y0 Z0;\\n"
layer_start = ""
line_start = ""
# segment_first = """G0 X{x:.4f} Y{y:.4f};
# M10 P0 S100;\\nG04 P500;\\n"""
segment_first = """G0 X{x:.4f} Y{y:.4f};
M10 P0 S100;\\n"""
segment = """G01 X{x:.4f} Y{y:.4f} F1000\\n"""
# line_end = """M10 P0 S30;\\nG04 P500;\\n"""
line_end = """M10 P0 S30;\\n"""
document_end = "M10 P0 S30\\nG0 X0 Y0"
invert_y = true
'''

with open("config.toml", "w") as f:
    f.write(config)

import asyncio
loop = asyncio.get_event_loop()

import time
text = None

from pyscript import when

import vpype_cli

import js
def handler(loop, context):
    js.console.error(context.message)
    raise(context.exception)
loop.set_exception_handler(handler)


async def process_file():
    global text
    file_input = Element("file-upload")
    uploaded_file = file_input.element.files.item(0)
    if uploaded_file is None:
        return

    display("hi", target="output")
    file_name = uploaded_file.name
    text = await uploaded_file.text()

    with open("input.svg", "w") as f:
        f.write(text)

    #print(text)
    display("done", target="output")

    width = 16
    height = 9

    command = f"read input.svg trim 1 1 linemerge --tolerance 0.1mm linesort scaleto {width}cm {height}cm layout tight "

    vpype_cli.execute(command + "gwrite --profile my_own_plotter output.gcode", global_opt="-c config.toml")
    vpype_cli.execute(command + "write --pen-up output.svg", global_opt="-c config.toml")

    with open("output.svg") as f:
        svg_as_string = f.read()

    with open("output.gcode") as f:
        gcode = f.read()

    dest_elem = js.document.getElementById("output-image")
    dest_elem.innerHTML = svg_as_string

    </py-script>

    <py-repl id="my-repl" auto-generate="true"> </py-repl>

</body>

</html>
